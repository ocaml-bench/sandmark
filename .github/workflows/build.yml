name: CI

on: [push, pull_request]

jobs:

jobs:
  build:
    name: '5.00.0+trunk'
    runs-on: 'ubuntu-latest'
    container:
      image: ocaml/opam:ubuntu-20.04-ocaml-4.12
    steps:
      - name: Cleaning up the $GITHUB_WORKSPACE as root from a Docker image
        # Volume auto mounted by gh actions pointing to the current working-directory
        run: find /__w/${{ github.event.repository.name }}/${{ github.event.repository.name }}/. -name . -o -prune -exec rm -rf -- {} + || true
      - name: Checkout
        uses: actions/checkout@v2
      - name: Install dependencies
        run: |
          sudo apt-get -y update && sudo apt-get -y install wget pkg-config libgmp-dev m4 libdw-dev jq python3-pip
      - name: Opam update
        run: |
          sudo chown -R opam .
          eval $(opam env)
          opam update
      - name: Install dune
        run: |
          opam install dune.2.9.0
      - name: Export environment variables
        run: |
          export ITER=1
          export OPAM_DISABLE_SANDBOXING=true
      - name: Build and run benchmarks
        run: |
          TAG='"run_in_ci"' make run_config_filtered.json
          RUN_CONFIG_JSON=run_config_filtered.json make ocaml-versions/5.00.0+trunk.bench
      - name: View results
        run: |
          ls _results
          cat _results/*
